<!DOCTYPE html>
<html>
    <head>
        <title>Teste API</title>
		<script type="text/javascript" src="https://public.tableau.com/javascripts/api/tableau-2.min.js"></script>
        <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.4/css/jquery.dataTables.css">  
        <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.css">  
        <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.4/css/dataTables.bootstrap4.min.css">  
        
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.4/js/jquery.dataTables.js"></script>

        <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
        <script type="text/javascript" charset="utf8" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
        <script type="text/javascript" charset="utf8" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
        <script type="text/javascript" charset="utf8" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
        <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
        <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.print.min.js"></script>
        
        <style>

            .dt-buttons{
                margin-bottom: -30px;
            }


        </style>

        <script type="text/javascript">

			$.urlParam = function(name){
				var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
				if (results==null) {
				   return null;
				}
				return decodeURI(results[1]) || 0;
			}

            $.fn.dataTable.ext.errMode = 'none';
            var viz, sheet, table;
            var dados;
            var linhas = {};
            var linhas2 = {};
            var tb, tb2;
            var data, data2;
            var ultimo_ano, ultimo_mes;
			var ano_atual_global = $.urlParam('ano');
            var mes = $.urlParam('mes')
			var uf = $.urlParam('UF');
            //var mes = ["Janeiro"]
           
			var tabela = [];
            
            
            function initViz() {              

                var containerDiv = document.getElementById("vizContainer"),
                url = "https://public.tableau.com/views/TempodeAberturadeEmpresas_15877424223640/PorEstado",
                options = {
                    "sig_uf (municipio_ibge.csv)": uf,
                    "mes_deferimento": mes,
                    "ano_deferimento": ano_atual_global,
                    onFirstInteractive: function () {
                        getData();
                    }
                };
				console.log(options);
                if (viz) {
					try{
						viz.dispose();
					}catch(e){
						console.log('Erro',e);
					}
                    
                }
                $("#log").text("Carregando " + mes + "/" + ano_atual_global);
                viz = new tableau.Viz(containerDiv, url, options);

            }
            

            function getData() {

                sheet = viz.getWorkbook().getActiveSheet().getWorksheets().get("Total por Municipio - Menores");
                
                options = {
                    maxRows: 0, // Max rows to return. Use 0 to return all rows
                    ignoreAliases: false,
                    ignoreSelection: true,
                    includeAllColumns: false
                };
                
                try {
                    sheet.getUnderlyingDataAsync(options).then(function (t) {
                       
                        table = t;
                        tb = $("#tb");
                        tb2 = $("#tb2");

                        
                        dados = table.getData();
						$("#vizContainer").hide();
						$("#log").hide();
						
						var cont = 0;
						var cabecalho = ["ID", "Ano","Cidade","UF","UF", "N", "Mês","Região","Tipo","Qtd", "T1","T2","T3","T4","T5","T6","T7","Qtd2" ];
						for(var d of dados){
							cont ++;
							var linha = [];	
							for(var x = 0; x < 18; x++){
							
								linha.push(d[x].value);						
							
							}		
							tabela.push(linha);
						}
						console.log(cont);
						
						$('#tabelas').DataTable({
							data: tabela,
							paging: false,
							columns: [
								{ title: 'ID' },
								{ title: 'Ano' },
								{ title: 'Cidade' },
								{ title: 'UF' },
								{ title: 'UF' },
								{ title: 'N' },
								{ title: 'Mês' },
								{ title: 'Região' },
								{ title: 'Tipo' },
								{ title: 'Qtd' },
								{ title: 'T1' },
								{ title: 'T2' },
								{ title: 'T3' },
								{ title: 'T4' },
								{ title: 'T5' },
								{ title: 'T6' },
								{ title: 'T7' },
								{ title: 'Qtd2' }
							],							
						});
						//downloadCSV(convertToCSV(tabela));
                      
                    }),
                    function (err) {
                        console.log('erro', err);
                    }
                } catch (e) {
                    console.log('erro', e);
                }
               
            }
			
			function convertToCSV(arr) {
			  const array = [Object.keys(arr[0])].concat(arr)

			  return array.map(it => {
				return Object.values(it).toString()
			  }).join('\n')
			}


			function downloadCSV(dados) {  
			
				  var myBlob = new Blob([dados], {type: "text/csv"});
				  var url = window.URL.createObjectURL(myBlob);
				  var anchor = document.createElement("a");
				  anchor.href = url;
				  anchor.download = "export.csv";
				  anchor.click();
			}
	
	
        </script>
    </head>

    <body onload="initViz();">
        <div class="page-header">           
            <h5 id="log" style="margin: 10px;" >Iniciando...</h5>
        </div>
        <div style="margin: 10px;" id="vizContainer" style="width:800px; height:0px; display: none;"></div>
       
		<table id="tabelas" class="display" width="100%"></table>
    </body>
</html>
